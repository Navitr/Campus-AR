<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Mapa AR Campus - Controles Avanzados</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.js"></script>

    <style>
        /* --- ESTILOS GENERALES UI --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        .ui-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .ui-container > * { pointer-events: auto; }

        .message-box {
            background: rgba(0, 0, 0, 0.7); color: white; padding: 10px;
            text-align: center; width: 100%; font-size: 14px;
        }

        /* --- MENÚ LATERAL --- */
        .building-menu {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            display: none; flex-direction: column; gap: 8px;
            max-height: 60vh; overflow-y: auto;
        }

        .building-btn {
            background: rgba(255, 255, 255, 0.9); border: none; padding: 8px 12px;
            border-radius: 8px; font-weight: bold; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;
            text-align: right; font-size: 14px;
        }
        .building-btn:active, .building-btn.active {
            background: #0077FF; color: white;
        }

        /* --- TARJETA DE INFORMACIÓN --- */
        .info-card {
            display: none; position: absolute; top: 60px; left: 50%;
            transform: translateX(-50%); width: 85%; max-width: 400px;
            background: white; padding: 15px 20px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; top: 40px; } to { opacity: 1; top: 60px; } }
        .info-card h2 { margin: 0 0 5px 0; color: #0077FF; font-size: 18px; }
        .info-card p { margin: 0; color: #555; font-size: 14px; line-height: 1.4; }
        .close-card { position: absolute; top: 5px; right: 10px; font-size: 20px; color: #999; cursor: pointer; }

        /* --- BOTONES INFERIORES (GRID) --- */
        .bottom-controls {
            display: flex; justify-content: center; flex-wrap: wrap;
            gap: 10px; margin-bottom: 20px; padding: 0 10px;
        }

        .ar-button {
            padding: 10px 16px; font-size: 13px; font-weight: bold;
            color: white; border: none; border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer;
            flex: 0 1 auto; /* Permite que se ajusten si falta espacio */
        }
        #btn-toggle-info { background-color: #0077FF; } /* Azul */
        #btn-toggle-pointer { background-color: #FF9800; } /* Naranja */
        #btn-toggle-user { background-color: #9C27B0; } /* Morado */
        #btn-contrast { background-color: #4CAF50; } /* Verde */
    </style>

    <script>
        const buildingsData = {
            "ema": { title: "Edificio EMA", desc: "Nivel 1: Biblioteca y salones de Danza. Nivel 2: Computadoras. Nivel 3 a 5: Salones normales", position: "0.45 -0.1 0.6" },
            "arpa": { title: "ARPA 3", desc: "Salón para stop motion, salón con pantalla verde, administración arpa.", position: "-0.035 -0.55 0.6" },
            "dramatico": { title: "Arte dramatico", desc: "Edificio de la licenciatura de Arte Dramatico.", position: "-0.6 -0.1 0.6" },
            "musica": { title: "Musica", desc: "Edificio de la facultad de Música.", position: "0.25 1.1 0.6" }
        };

        AFRAME.registerComponent('campus-ar-manager', {
            init: function () {
                const self = this;
                const marker = document.querySelector('a-marker');
                
                // Referencias UI
                const infoCard = document.getElementById('info-card');
                const cardTitle = document.getElementById('card-title');
                const cardDesc = document.getElementById('card-desc');
                const menu = document.querySelector('.building-menu');
                
                // Referencias 3D
                const pointer = document.getElementById('3d-pointer');
                const userLocation = document.getElementById('user-location'); // ID NUEVO
                const labels = document.querySelectorAll('.label-group'); // Etiquetas normales
                
                // Estado
                let labelsVisible = false;
                let highContrast = false;
                let pointerVisible = false; // Estado lógico del puntero
                let userVisible = false; // Estado ubicación usuario

                // --- 1. SELECCIÓN DE EDIFICIO ---
                window.selectBuilding = function(key) {
                    const data = buildingsData[key];
                    if (!data) return;

                    // Mostrar Info
                    cardTitle.textContent = data.title;
                    cardDesc.textContent = data.desc;
                    infoCard.style.display = 'block';

                    // Activar Puntero (Siempre se activa al seleccionar nuevo edificio)
                    pointer.setAttribute('visible', true);
                    pointer.setAttribute('position', data.position);
                    pointerVisible = true; 
                    updateButtonText('btn-toggle-pointer', 'Ocultar Puntero');

                    // UI Botones
                    document.querySelectorAll('.building-btn').forEach(b => b.classList.remove('active'));
                    document.getElementById('btn-' + key).classList.add('active');
                };

                // --- 2. BOTONES DE CONTROL ---
                
                // A. Etiquetas (Info General)
                document.getElementById('btn-toggle-info').addEventListener('click', (e) => {
                    e.stopPropagation();
                    labelsVisible = !labelsVisible;
                    labels.forEach(l => l.setAttribute('visible', labelsVisible));
                    e.target.textContent = labelsVisible ? 'Ocultar Info' : 'Ver Info';
                });

                // B. Puntero (Cono)
                document.getElementById('btn-toggle-pointer').addEventListener('click', (e) => {
                    e.stopPropagation();
                    pointerVisible = !pointerVisible;
                    pointer.setAttribute('visible', pointerVisible);
                    updateButtonText(e.target.id, pointerVisible ? 'Ocultar Puntero' : 'Ver Puntero');
                });

                // C. Ubicación Usuario (Esfera)
                document.getElementById('btn-toggle-user').addEventListener('click', (e) => {
                    e.stopPropagation();
                    userVisible = !userVisible;
                    userLocation.setAttribute('visible', userVisible);
                    updateButtonText(e.target.id, userVisible ? 'Ocultar Ubicación' : 'Ver Ubicación');
                });

                // D. Contraste
                document.getElementById('btn-contrast').addEventListener('click', (e) => {
                    e.stopPropagation();
                    highContrast = !highContrast;
                    const bg = highContrast ? '#FFFFFF' : '#000000';
                    const txt = highContrast ? '#000000' : '#00AEEF';

                    // Etiquetas normales
                    document.querySelectorAll('.label-bg').forEach(el => el.setAttribute('material', 'color', bg));
                    document.querySelectorAll('.label-text').forEach(el => el.setAttribute('text', 'color', txt));
                    
                    // Etiqueta Usuario (Especial)
                    const uBg = document.querySelector('.label-bg-special');
                    const uTxt = document.querySelector('.label-text-special');
                    if(uBg) uBg.setAttribute('material', 'color', highContrast ? '#FFFFFF' : '#FF0000');
                    if(uTxt) uTxt.setAttribute('text', 'color', highContrast ? '#FF0000' : '#FFFFFF');

                    e.target.textContent = highContrast ? 'Original' : 'Contraste';
                });

                // Helper para texto de botones
                function updateButtonText(id, text) {
                    document.getElementById(id).textContent = text;
                }

                // Cerrar tarjeta
                document.querySelector('.close-card').addEventListener('click', () => {
                    infoCard.style.display = 'none';
                    // Opcional: Ocultar puntero al cerrar tarjeta
                    // pointer.setAttribute('visible', false); 
                    document.querySelectorAll('.building-btn').forEach(b => b.classList.remove('active'));
                });

                // --- MARCADOR ---
                marker.addEventListener('markerFound', () => {
                    document.getElementById('status-message').textContent = '¡Mapa detectado!';
                    self.el.setAttribute('visible', true);
                    menu.style.display = 'flex';
                });

                marker.addEventListener('markerLost', () => {
                    document.getElementById('status-message').textContent = 'Escanea el Código QR.';
                    self.el.setAttribute('visible', false);
                    menu.style.display = 'none';
                    infoCard.style.display = 'none';
                });
            }
        });
    </script>
</head>

<body>
    <div class="ui-container">
        <div id="status-message" class="message-box">Escanea el Código QR</div>

        <div id="info-card" class="info-card">
            <span class="close-card">&times;</span>
            <h2 id="card-title"></h2>
            <p id="card-desc"></p>
        </div>

        <div class="building-menu">
            <button id="btn-ema" class="building-btn" onclick="selectBuilding('ema')">EMA</button>
            <button id="btn-arpa" class="building-btn" onclick="selectBuilding('arpa')">ARPA 3</button>
            <button id="btn-dramatico" class="building-btn" onclick="selectBuilding('dramatico')">Dramatico</button>
            <button id="btn-musica" class="building-btn" onclick="selectBuilding('musica')">Musica</button>
        </div>

        <div class="bottom-controls">
            <button id="btn-toggle-info" class="ar-button">Ver Info</button>
            <button id="btn-toggle-pointer" class="ar-button">Ver Puntero</button>
            <button id="btn-toggle-user" class="ar-button">Ver Ubicación</button>
            <button id="btn-contrast" class="ar-button">Contraste</button>
        </div>
    </div>

    <a-scene embedded arjs='sourceType: webcam; detectionMode: mono; patternRatio: 0.9;' vr-mode-ui="enabled: false;">
        <a-light type="ambient" color="#CCC"></a-light>
        <a-light type="directional" position="1 2 4" color="#FFF"></a-light>

        <a-marker type='pattern' url='campus_qr.patt'>
            <a-entity campus-ar-manager visible="false" rotation="-90 0 0" position="0 0 0" scale="0.4 0.4 0.4">
                
                <a-gltf-model src="mapa.glb" position="0 0 0" scale=".2 .2 .2" rotation="90 0 0"></a-gltf-model>

                <a-entity id="3d-pointer" position="0 0 0" visible="false">
                    <a-cone color="#FFD700" radius-bottom="0.01" radius-top="0.08" height="0.25" position="0 0.2 0" opacity="0.9"></a-cone>
                    <a-entity animation="property: position; to: 0 0.2 0; dir: alternate; loop: true; dur: 800"></a-entity>
                </a-entity>

                <a-entity id="user-location" position="0.7 .65 .5" visible="false" scale="1 1 1">
                    <a-sphere color="#FF0000" radius="0.06" position="0. 0.2 -0.38"></a-sphere>
                    <a-entity position="0.35 0.15 0">
                        <a-plane class="label-bg-special" width=".6" height="0.2" color="#FF0000" position="0 0 -0.01"></a-plane>
                        <a-text class="label-text-special" value="Tu estas aqui" align="center" color="#FFFFFF" width="1.6" font="roboto" shader="msdf"></a-text>
                    </a-entity>
                </a-entity>

                <a-entity position=".45 -.1 0.5" class="label-group" visible="false">
                    <a-plane class="label-bg" width="0.8" height="0.3" color="#000000" opacity="0.9" position="0 0 -0.01"></a-plane>
                    <a-text class="label-text" value="EMA" align="center" color="#00AEEF" width="1.8" font="roboto" shader="msdf"></a-text>
                </a-entity>
                
                <a-entity position="-0.035 -0.55 0.5" class="label-group" visible="false">
                    <a-plane class="label-bg" width="0.8" height="0.3" color="#000000" opacity="0.9" position="0 0 -0.01"></a-plane>
                    <a-text class="label-text" value="ARPA 3" align="center" color="#00AEEF" width="1.8" font="roboto" shader="msdf"></a-text>
                </a-entity>

                <a-entity position="-0.6 -0.1 0.5" class="label-group" visible="false">
                    <a-plane class="label-bg" width="0.8" height="0.3" color="#000000" opacity="0.9" position="0 0 -0.01"></a-plane>
                    <a-text class="label-text" value="Dramatico" align="center" color="#00AEEF" width="1.8" font="roboto" shader="msdf"></a-text>
                </a-entity>

                <a-entity position="0.25 1.1 0.5" class="label-group" visible="false">
                    <a-plane class="label-bg" width="0.8" height="0.3" color="#000000" opacity="0.9" position="0 0 -0.01"></a-plane>
                    <a-text class="label-text" value="Musica" align="center" color="#00AEEF" width="1.8" font="roboto" shader="msdf"></a-text>
                </a-entity>

            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>




































